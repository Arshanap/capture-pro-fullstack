<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>Evara Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:title" content="">
        <meta property="og:type" content="">
        <meta property="og:url" content="">
        <meta property="og:image" content="">
        <!-- Favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="/assets/imgs/theme/favicon.svg">
        <link rel="stylesheet" href="/assets/imgs/theme/favicon.svg">
        <!-- Template CSS -->
        <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    </head>
   <style>
    .success-message {
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #4CAF50;
    background-color: #DFF2BF;
    color: #4F8A10;
    border-radius: 5px;
    font-size: 14px;
    text-align: center;
}
   .success-message {
        background-color: #4CAF50;
        color: white;
        padding: 10px;
        margin-bottom: 20px;
        text-align: center;
        border-radius: 5px;
    }
    .error-message {
        background-color: #f44336; 
        color: white;
        padding: 10px;
        margin-bottom: 20px;
        text-align: center;
        border-radius: 5px;
    } 

   </style> 
    <body>
        <div class="screen-overlay"></div>
        <aside class="navbar-aside" id="offcanvas_aside">
            <div class="aside-top">
                <a href="" class="brand-wrap">
                    <img src="/assets/imgs/captureLogo.png" class="logo" alt="Evara Dashboard" >
                </a>
                <div>
                    <!-- <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i> </button> -->
                </div>
            </div>
            <nav>
                <ul class="menu-aside">
                    <li class="menu-item ">
                        <a class="menu-link" href="/admin//dashboard"> <i class="icon material-icons md-home"></i>
                            <span class="text">Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href="/admin/products"> <i class="icon material-icons md-shopping_bag"></i>
                            <span class="text">Products</span>
                        </a>
                    
                    </li>
                    <li class="menu-item active">
                        <a class="menu-link" href="/admin/order"> <i class="icon material-icons md-shopping_cart"></i>
                            <span class="text">Order list</span>
                        </a>
      
                    </li>
                    <li class="menu-item ">
                         
                        <a href="/admin/users" class="menu-link" style="right: -10px; position: relative; color: #292f46;">   
                            <i class="icon material-icons md-person"></i>  users</a>
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="icon material-icons md-add_box"></i>
                            <span class="text">Coupons</span>
                        </a>
                    </li>
                    
                    <li class="menu-item"></li>
                        <a class="menu-link" href="/admin/category"> <i style="font-size: 117%; color: #adadad; right:0%" class="icon material-icons md-monetization_on "></i>
                            <span class="text">category</span>
                        </a>
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="fas fa-bullhorn" style="font-size: 117%; color: #adadad; right:2%"></i>
                            <span class="text" style="left:7%; position:  relative;">banners</span>
                        </a>
                     
                    </li>
                   
                    <li class="menu-item">
                        <a class="menu-link" href=""> <i class="icon material-icons md-comment"></i>
                            <span class="text">Offers</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href=""> <i class="icon material-icons md-stars"></i>
                            <span class="text">Payments</span> </a>
                    </li>
                  
                </ul>
                <hr>
                <ul class="menu-aside">
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="icon material-icons md-settings"></i>
                            <span class="text">Settings</span>
                        </a>
                        <!-- <div class="submenu">
                            <a href="page-settings-1.html">Setting sample 1</a>
                            <a href="page-settings-2.html">Setting sample 2</a>
                        </div> -->
                    </li>
                    <li class="menu-item">
                        <a  style="left: 5%; font-size: 10px;" class="menu-link" href="/admin/Logout"> <i class="fa-solid fa-right-from-bracket">  Logout </i> 
                         
                        </a >
                    </li>
                </ul>
                <br>
                <br>
            </nav>
        </aside>
        <main class="main-wrap">
            <header class="main-header navbar">
                <div class="col-search">
                    <!-- <form class="searchform">
                        <div class="input-group">
                            <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                            <button class="btn btn-light bg" type="button"> <i class="material-icons md-search"></i></button>
                        </div>
                    </form> -->
                </div>
                <div class="col-nav">
                    <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                    <ul class="nav">
                        
                </div>
            </header>

            <div class="container mt-5">
                <h2 class="mb-4">Orders List</h2>
                <div id="successMessage" class="alert" style="display: none;"></div>
                <div id="errorMessage" class="alert" style="display: none;"></div>
                <table class="table table-bordered table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Order ID</th>
                            <th>User</th>
                            <th scope="col">Product Name</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Price</th>
                            <th scope="col">Status</th>
                            <th scope="col">Order Date</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    <% orders.forEach((orderItem) => { %>
                        <% orderItem.orderedItems.forEach((item) => { %>
                            <tr>
                                <td>#<%= orderItem.orderId %></td>
                                <td><%= orderItem.userId.name %></td>
                                <td><%= item.name %></td>
                                <td><%= item.quantity %></td>
                                <td>â‚¹ <%= item.price.toFixed(2) %></td>
                                <td><%if(orderItem.status === "Cancelled"){%>
                                    <span class="badge bg-danger"><%= orderItem.status %></span>
                                <%}else{%>
                                    <span class="badge bg-success"><%= orderItem.status %></span>
                                <%}%></td>
                                <td><%= orderItem.createdOn.toDateString() %></td>
                                <td>
                                    <!-- Action buttons -->
                                    <button class="btn-primary btn-sm" style="width: 80px;" data-order-id="<%= orderItem._id %>" data-bs-toggle="modal" data-bs-target="#statusModal">Status</button>

                                    <%if(orderItem.status === "Cancelled"){%>
                                        <button class="btn-sm" data-order-id1="<%= orderItem._id %>" style=" width: 80px;" disabled>Cancel</button>
                                        <%}else{%>
                                        <button class=" btn-danger btn-sm" data-order-id1="<%= orderItem._id %>" onclick="return cancelfun(event)" style=" width: 80px;">Cancel</button>
                                    <%}%>
                                    <input type="hidden" id="orderIdInput1" name="orderId1" value="">
                                </td>
                            </tr>
                        <% }) %>
                    <% }) %>
                    </tbody>
                </table>
            </div>
    
            <!-- Modal for Changing Order Status -->
            <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="statusModalLabel">Change Order Status</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                            <form id="changeStatusForm" onsubmit="return changeStatus(event)">
                                <div class="form-group">
                                    <label for="orderStatus">Order Status</label>
                                    <select name="status" id="orderStatus" class="form-control">
                                        <% statuses.forEach((status) => { %>
                                            <option value="<%= status %>"><%= status.charAt(0).toUpperCase() + status.slice(1) %></option>
                                        <% }) %>
                                    </select>
                                    <input type="hidden" id="orderIdInput" name="orderId" value="">
                                </div>
                                <button type="submit" class="btn btn-primary">Update Status</button>
                            </form>
                                                                                  
                            
                        </div>
                    </div>
                </div>
            </div>
        </main>



    </main>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
    const statusButtons = document.querySelectorAll("[data-order-id]");
    statusButtons.forEach(button => {
        button.addEventListener("click", function(event) {
            const orderId = this.getAttribute("data-order-id");
            console.log("Clicked Order ID:", orderId); 
            document.getElementById("orderIdInput").value = orderId;
        });
    });
});

async function changeStatus(event) {
    event.preventDefault();

    const statusElement = document.getElementById("orderStatus");
    const statusValue = statusElement.value;
    const orderId = document.getElementById("orderIdInput").value;

    

    try {
        const response = await axios.post("/admin/changeOrderStatus", {
            orderId: orderId,
            status: statusValue
        });

        if (response.status === 200) {
            showSuccessMessage("Status updated successfully!");

            const modalElement = document.getElementById("statusModal");
            const modalInstance = bootstrap.Modal.getInstance(modalElement); // Bootstrap 5 method
            modalInstance.hide();
            setTimeout(() => {
                window.location.reload()
            }, 2000);

        } else {
            showErrorMessage("Failed to update status. Status code: " + response.status);
        }
    } catch (error) {
        showErrorMessage("Error updating status: " + error.message);
    }
}



function showSuccessMessage(message) {
    const successMessageContainer = document.getElementById("successMessage");
    successMessageContainer.classList.add("alert-success"); // Bootstrap class for success
    successMessageContainer.classList.remove("alert-danger"); // Remove error class if previously added
    successMessageContainer.textContent = message;

    // Show the message
    successMessageContainer.style.display = "block";

    // Hide the message after 3 seconds
    setTimeout(() => {
        successMessageContainer.style.display = "none";
    }, 3000);
}

function showErrorMessage(message) {
    const errorMessageContainer = document.getElementById("errorMessage");
    errorMessageContainer.classList.add("alert-danger"); // Bootstrap class for error
    errorMessageContainer.classList.remove("alert-success"); // Remove success class if previously added
    errorMessageContainer.textContent = message;

    // Show the message
    errorMessageContainer.style.display = "block";

    // Hide the message after 3 seconds
    setTimeout(() => {
        errorMessageContainer.style.display = "none";
    }, 3000);
}


        </script>


<script>
document.addEventListener("DOMContentLoaded", function() {
        const statusButtons = document.querySelectorAll("[data-order-id1]");
        statusButtons.forEach(button => {
            button.addEventListener("click", function(event) {
                const orderId = this.getAttribute("data-order-id1");
                document.getElementById("orderIdInput1").value = orderId;
                cancelfun(event, orderId); // Pass the orderId to the cancelfun
            });
        });
    });


function cancelfun(event) {
        event.preventDefault(); // Prevent default action (if any)
        
        const orderId = document.getElementById("orderIdInput1").value;

       

        Swal.fire({
            title: "Are you sure?",
            text: "Your cancel this user order!",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, cancel it!"
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: "Cancelled!",
                    text: "This Order has been cancelled.",
                    icon: "success",
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    axios.post("/admin/cancelOrder", {
                        Id: orderId,
                    }).then(response => {
                        console.log("Order cancelled successfully:", response);
                        window.location.reload();
                    }).catch(error => {
                        console.error("Error cancelling the order:", error);
                    });
                });
            }
        });
    }
</script>
        


 
    
    
    
    <!-- <script src="assets/js/vendors/jquery-3.6.0.min.js"></script> -->
     <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
    
    <!-- <script src="assets/js/vendors/bootstrap.bundle.min.js"></script> -->
     <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <!-- <script src="assets/js/vendors/select2.min.js"></script> -->
     <script src="/assets/js/vendors/select2.min.js"></script>
    <!-- <script src="assets/js/vendors/perfect-scrollbar.js"></script> -->
     <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/assets/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="/assets/js/main.js" type="text/javascript"></script>
    <script src="/assets/js/custom-chart.js" type="text/javascript"></script>

   
</body>
</html>