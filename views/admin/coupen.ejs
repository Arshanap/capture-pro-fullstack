<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>Evara Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:title" content="">
        <meta property="og:type" content="">
        <meta property="og:url" content="">
        <meta property="og:image" content="">
        <!-- Favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="/assets/imgs/theme/favicon.svg">
        <link rel="stylesheet" href="/assets/imgs/theme/favicon.svg">
        <!-- Template CSS -->
        <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    </head>
    
    <body>
        <div class="screen-overlay"></div>
        <aside class="navbar-aside" id="offcanvas_aside">
            <div class="aside-top">
                <a href="" class="brand-wrap">
                    <img src="/assets/imgs/captureLogo.png" class="logo" alt="Evara Dashboard" >
                </a>
                <div>
                    <!-- <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i> </button> -->
                </div>
            </div>
            <nav>
                <ul class="menu-aside">
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="icon material-icons md-home"></i>
                            <span class="text">Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href="/admin/products"> <i class="icon material-icons md-shopping_bag"></i>
                            <span class="text">Products</span>
                        </a>
                    
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="icon material-icons md-shopping_cart"></i>
                            <span class="text">Order list</span>
                        </a>
      
                    </li>
                    <li class="menu-item ">
                         
                        <a href="/admin/users" class="menu-link" style="right: -10px; position: relative; color: #292f46;">   
                            <i class="icon material-icons md-person"></i>  users</a>
                    </li>
                    <li class="menu-item active">
                        <a class="menu-link" href=""> <i class="icon material-icons md-add_box"></i>
                            <span class="text">Coupons</span>
                        </a>
                    </li>
                    
                    <li class="menu-item"></li>
                        <a class="menu-link" href="/admin/category"> <i style="font-size: 117%; color: #adadad; right:0%" class="icon material-icons md-monetization_on "></i>
                            <span class="text">category</span>
                        </a>
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="fas fa-bullhorn" style="font-size: 117%; color: #adadad; right:2%"></i>
                            <span class="text" style="left:7%; position:  relative;">banners</span>
                        </a>
                     
                    </li>
                   
                    <li class="menu-item">
                        <a class="menu-link" href=""> <i class="icon material-icons md-comment"></i>
                            <span class="text">Offers</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href=""> <i class="icon material-icons md-stars"></i>
                            <span class="text">Payments</span> </a>
                    </li>
                  
                </ul>
                <hr>
                <ul class="menu-aside">
                    <li class="menu-item ">
                        <a class="menu-link" href=""> <i class="icon material-icons md-settings"></i>
                            <span class="text">Settings</span>
                        </a>
                        <!-- <div class="submenu">
                            <a href="page-settings-1.html">Setting sample 1</a>
                            <a href="page-settings-2.html">Setting sample 2</a>
                        </div> -->
                    </li>
                    <li class="menu-item">
                        <a  style="left: 5%; font-size: 10px;" class="menu-link" href="/admin/Logout"> <i class="fa-solid fa-right-from-bracket">  Logout </i> 
                         
                        </a >
                    </li>
                </ul>
                <br>
                <br>
            </nav>
        </aside>
        <main class="main-wrap">
            <header class="main-header navbar">
                <div class="col-search">
                    <!-- <form class="searchform">
                        <div class="input-group">
                            <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                            <button class="btn btn-light bg" type="button"> <i class="material-icons md-search"></i></button>
                        </div>
                    </form> -->
                </div>
                <div class="col-nav">
                    <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                    <ul class="nav">
                        
                </div>
            </header>
  <div class="container my-4">
    <h2 class="text-center mb-4">Coupon List</h2>
    
    <!-- Add New Coupon Button -->
    <div class="text-end mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponModal">Add New Coupon</button>
    </div>

    <!-- Coupon List Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th scope="col">Coupon Code</th>
            <th scope="col">Discount Type</th>
            <th scope="col">D Amount</th>
            <th scope="col">M P Amount</th>
            <th scope="col">MX Amount</th>
            <th scope="col">usageLimit</th>
            <th scope="col">End Date</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
         <% coupon.forEach((item)=>{ %>
          <tr>
            <td><%=item.code%></td>
            <td><%=item.discountType%></td>
            <td><%=item.discountAmount%></td>
            <td><%=item.minPurchaseAmount%></td>
            <td><%=item.maxDiscount%></td>
            <td><%=item.usageLimit%></td>
            <td><%=item.expirationDate.toDateString()%></td>
            <td>
            <% if(item.isActive === true){ %>
                <span class="badge bg-success">Active</span>
            <% }else{ %>
                <span class="badge bg-danger">nonActive</span>
            <% } %>
            </td>
            <td>
              <a href="/admin/editCoupon?id=<%=item._id%>"><button class="btn btn-sm btn-info">Edit</button></a>
              <button onclick="return removeCoupon('<%= item._id %>')" class="btn btn-sm btn-danger">Delete</button>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Coupon Modal -->
  <div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCouponModalLabel">Add New Coupon</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="couponForm">
                <!-- Coupon Code -->
                <div class="mb-3">
                  <label for="couponCode" class="form-label">Coupon Code</label>
                  <input type="text" name="code" class="form-control" id="couponCode">
                  <div class="text-danger" id="couponCodeError"></div>
                </div>
              
                <!-- Discount Type -->
                <div class="mb-3">
                  <label for="discountType" class="form-label">Discount Type</label>
                  <select class="form-select" name="discountType" id="discountType">
                    <!-- <option value="percentage">Percentage</option> -->
                    <option value="fixed">Fixed</option>
                  </select>
                  <div class="text-danger" id="discountTypeError"></div>
                </div>
              
                <!-- Discount Amount -->
                <div class="mb-3">
                  <label for="discountAmount" class="form-label">Discount Amount</label>
                  <input type="number" name="discountAmount" class="form-control" id="discountAmount">
                  <div class="text-danger" id="discountAmountError"></div>
                </div>
              
                <!-- Minimum Purchase Amount -->
                <div class="mb-3">
                  <label for="minPurchaseAmount" class="form-label">Minimum Purchase Amount</label>
                  <input type="number" name="minPurchaseAmount" class="form-control" id="minPurchaseAmount">
                  <div class="text-danger" id="minPurchaseAmountError"></div>
                </div>
              
                <!-- Expiration Date -->
                <div class="mb-3">
                  <label for="expirationDate" class="form-label">Expiration Date</label>
                  <input type="date" class="form-control" name="expirationDate" id="expirationDate">
                  <div class="text-danger" id="expirationDateError"></div>
                </div>
              
                <!-- Maximum Discount (Optional) -->
                <div class="mb-3">
                  <label for="maxDiscount" class="form-label">Maximum Discount</label>
                  <input type="number" class="form-control" name="maxDiscount" id="maxDiscount">
                  <div class="text-danger" id="maxDiscountError"></div>
                </div>
              
                <!-- Usage Limit (Optional) -->
                <div class="mb-3">
                  <label for="usageLimit" class="form-label">Usage Limit</label>
                  <input type="number" class="form-control" name="usageLimit" id="usageLimit">
                  <div class="text-danger" id="usageLimitError"></div>
                </div>
              
                <!-- Is Active -->
                <div class="mb-3">
                  <label for="isActive" class="form-label">Is Active</label>
                  <select class="form-select" name="isActive" id="isActive">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                  </select>
                  <div class="text-danger" id="isActiveError"></div>
                </div>
              
                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary">Add Coupon</button>
              </form>
              
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    function removeCoupon(couponId) {
  Swal.fire({
    title: 'Are you sure?',
    text: 'Do you want to delete this coupon? This action cannot be undone.',
    icon: 'warning',
    showCancelButton: true, 
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      axios.delete(`/admin/deleteCoupon?id=${couponId}`)
        .then(response => {
          Swal.fire({
            title: 'Deleted!',
            text: response.data.message || 'Coupon has been deleted successfully.',
            icon: 'success',
            timer: 1500, 
            showConfirmButton: false
          });

          setTimeout(() => {
            location.reload();
          }, 1500);
        })
        .catch(error => {
          Swal.fire({
            title: 'Error!',
            text: error.response?.data?.message || 'Failed to delete the coupon. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        });
    }
  });

  return false; 
}

  </script>

  <script>
    document.getElementById('couponForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent form submission
  
      let isValid = true;
      const errors = {
        couponCode: '',
        discountType: '',
        discountAmount: '',
        minPurchaseAmount: '',
        expirationDate: '',
        maxDiscount: '',
        usageLimit: '',
        isActive: '',
      };
  
      Object.keys(errors).forEach((field) => {
        document.getElementById(`${field}Error`).textContent = '';
      });
  
      const couponCode = document.getElementById('couponCode').value.trim();
      if (!couponCode) {
        errors.couponCode = 'Coupon Code is required.';
        isValid = false;
      }
  
      const discountType = document.getElementById('discountType').value;
      if (!discountType) {
        errors.discountType = 'Discount Type is required.';
        isValid = false;
      }
  
      const discountAmount = parseFloat(document.getElementById('discountAmount').value);
      if (isNaN(discountAmount) || discountAmount <= 0) {
        errors.discountAmount = 'Discount Amount must be a positive number.';
        isValid = false;
      }
  
      // Validate Minimum Purchase Amount
      const minPurchaseAmount = parseFloat(document.getElementById('minPurchaseAmount').value);
      if (isNaN(minPurchaseAmount) || minPurchaseAmount <= 0) {
        errors.minPurchaseAmount = 'Minimum Purchase Amount must be a positive number.';
        isValid = false;
      }
  
      // Validate Expiration Date
      const expirationDate = document.getElementById('expirationDate').value;
      if (!expirationDate) {
        errors.expirationDate = 'Expiration Date is required.';
        isValid = false;
      } else if (new Date(expirationDate) < new Date()) {
        errors.expirationDate = 'Expiration Date must be in the future.';
        isValid = false;
      }
  
      // Validate Maximum Discount (Optional)
      const maxDiscount = document.getElementById('maxDiscount').value;
      if (maxDiscount && parseFloat(maxDiscount) < 0) {
        errors.maxDiscount = 'Maximum Discount cannot be negative.';
        isValid = false;
      }
  
      // Validate Usage Limit (Optional)
      const usageLimit = document.getElementById('usageLimit').value;
      if (usageLimit && parseInt(usageLimit) < 0) {
        errors.usageLimit = 'Usage Limit cannot be negative.';
        isValid = false;
      }
  
      // Validate Is Active
      const isActive = document.getElementById('isActive').value;
      if (!isActive) {
        errors.isActive = 'Is Active selection is required.';
        isValid = false;
      }
  
      // Show error messages if validation fails
      if (!isValid) {
        Object.keys(errors).forEach((field) => {
          if (errors[field]) {
            document.getElementById(`${field}Error`).textContent = errors[field];
          }
        });
      } else {
        const formData = {
          couponCode,
          discountType,
          discountAmount,
          minPurchaseAmount,
          expirationDate,
          maxDiscount: maxDiscount || null,
          usageLimit: usageLimit || null,
          isActive
        };
  
        axios.post('/admin/addCoupen', formData)
        axios.post('/admin/addCoupen', formData)
        .then(response => {
            // Use SweetAlert for a success message without the "OK" button
            Swal.fire({
            title: 'Success!',
            text: response.data.message,
            icon: 'success',
            showConfirmButton: false, // Hide the "OK" button
            timer: 2000 // Automatically close the alert after 2 seconds
            }).then(() => {
            // Reload the page after the alert closes
            window.location.reload();
            });
        })
        .catch(error => {
            // Use SweetAlert for an error message
            Swal.fire({
            title: 'Error!',
            text: error.response?.data?.message || 'Failed to add coupon. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
            });
        });
    }
  });
      
  </script>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="assets/js/vendors/jquery-3.6.0.min.js"></script> -->
  <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
    
  <!-- <script src="assets/js/vendors/bootstrap.bundle.min.js"></script> -->
   <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <!-- <script src="assets/js/vendors/select2.min.js"></script> -->
   <script src="/assets/js/vendors/select2.min.js"></script>
  <!-- <script src="assets/js/vendors/perfect-scrollbar.js"></script> -->
   <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="/assets/js/vendors/chart.js"></script>
  <!-- Main Script -->
  <script src="/assets/js/main.js" type="text/javascript"></script>
  <script src="/assets/js/custom-chart.js" type="text/javascript"></script>

 
</body>
</html>
